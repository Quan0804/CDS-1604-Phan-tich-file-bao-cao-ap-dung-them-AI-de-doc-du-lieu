<%- include('partials/header') %>

<main class="main-content">
  <div class="container">
    <div class="history-section">
      <h1 class="page-title">
        <i class="fas fa-history"></i>
        L·ªãch S·ª≠ Ph√¢n T√≠ch
      </h1>

      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-info">
            <div class="stat-value"><%= stats.total_analyses || 0 %></div>
            <div class="stat-label">T·ªïng ph√¢n t√≠ch</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìà</div>
          <div class="stat-info">
            <div class="stat-value"><%= stats.total_charts || 0 %></div>
            <div class="stat-label">Bi·ªÉu ƒë·ªì ƒë√£ t·∫°o</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìÅ</div>
          <div class="stat-info">
            <div class="stat-value"><%= ((stats.avg_file_size || 0) / 1024).toFixed(1) %> KB</div>
            <div class="stat-label">K√≠ch th∆∞·ªõc TB</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üïí</div>
          <div class="stat-info">
            <div class="stat-value">
              <% if (stats.last_analysis_date) { %>
                <%= new Date(stats.last_analysis_date).toLocaleDateString('vi-VN') %>
              <% } else { %>
                Ch∆∞a c√≥
              <% } %>
            </div>
            <div class="stat-label">Ph√¢n t√≠ch g·∫ßn nh·∫•t</div>
          </div>
        </div>
      </div>

      <!-- Filter & Sort -->
      <div class="filter-section">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo t√™n file..." onkeyup="filterHistory()">
        </div>
        <div class="sort-options">
          <label>
            <i class="fas fa-sort"></i>
            S·∫Øp x·∫øp:
          </label>
          <select id="sortSelect" onchange="sortHistory()">
            <option value="date-desc">M·ªõi nh·∫•t</option>
            <option value="date-asc">C≈© nh·∫•t</option>
            <option value="name-asc">T√™n A-Z</option>
            <option value="name-desc">T√™n Z-A</option>
            <option value="size-desc">K√≠ch th∆∞·ªõc l·ªõn nh·∫•t</option>
            <option value="size-asc">K√≠ch th∆∞·ªõc nh·ªè nh·∫•t</option>
          </select>
        </div>
      </div>

      <!-- History List -->
      <div class="history-list" id="historyList">
        <% if (history && history.length > 0) { %>
          <% history.forEach((item, index) => { %>
            <div class="history-item" data-filename="<%= item.file_name.toLowerCase() %>" data-date="<%= new Date(item.upload_date).getTime() %>" data-size="<%= item.file_size %>">
              <div class="history-icon">
                <% 
                  let fileExt = item.file_name.split('.').pop().toLowerCase();
                  let iconClass = 'fa-file-alt';
                  let iconColor = 'default';
                  
                  if (fileExt === 'xlsx' || fileExt === 'xls') {
                    iconClass = 'fa-file-excel';
                    iconColor = 'excel';
                  } else if (fileExt === 'docx' || fileExt === 'doc') {
                    iconClass = 'fa-file-word';
                    iconColor = 'word';
                  } else if (fileExt === 'pptx' || fileExt === 'ppt') {
                    iconClass = 'fa-file-powerpoint';
                    iconColor = 'powerpoint';
                  } else if (fileExt === 'pdf') {
                    iconClass = 'fa-file-pdf';
                    iconColor = 'pdf';
                  }
                %>
                <i class="fas <%= iconClass %> icon-<%= iconColor %>"></i>
              </div>
              
              <div class="history-info">
                <h3 class="history-title">
                  <%= item.file_name %>
                  <span class="file-badge"><%= fileExt.toUpperCase() %></span>
                </h3>
                <div class="history-meta">
                  <span class="meta-item">
                    <i class="fas fa-calendar-alt"></i>
                    <%= new Date(item.upload_date).toLocaleString('vi-VN', { 
                      year: 'numeric', 
                      month: 'long', 
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    }) %>
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-chart-bar"></i>
                    <strong><%= item.charts_count %></strong> bi·ªÉu ƒë·ªì
                  </span>
                  <span class="meta-item">
                    <i class="fas fa-hdd"></i>
                    <%= (item.file_size / 1024).toFixed(2) %> KB
                  </span>
                </div>
                <% if (item.summary_preview) { %>
                  <p class="history-preview">
                    <i class="fas fa-quote-left" style="font-size: 0.7rem; opacity: 0.5; margin-right: 0.25rem;"></i>
                    <%= item.summary_preview %>...
                  </p>
                <% } %>
              </div>

              <div class="history-actions">
                <a href="/history/view/<%= item.id %>" class="btn btn-sm btn-primary" title="Xem chi ti·∫øt">
                  <i class="fas fa-eye"></i>
                  <span class="btn-text">Xem</span>
                </a>
                <a href="/history/export/<%= item.id %>" class="btn btn-sm btn-success" target="_blank" title="Xu·∫•t PDF">
                  <i class="fas fa-file-pdf"></i>
                  <span class="btn-text">PDF</span>
                </a>
                <button onclick="deleteAnalysis('<%= item.id %>')" class="btn btn-sm btn-danger" title="X√≥a ph√¢n t√≠ch">
                  <i class="fas fa-trash-alt"></i>
                  <span class="btn-text">X√≥a</span>
                </button>
              </div>
            </div>
          <% }); %>
        <% } else { %>
          <div class="empty-state">
            <i class="fas fa-folder-open"></i>
            <h3>Ch∆∞a c√≥ l·ªãch s·ª≠ ph√¢n t√≠ch</h3>
            <p>H√£y upload file ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch!</p>
            <a href="/upload" class="btn btn-primary">
              <i class="fas fa-upload"></i>
              Upload File
            </a>
          </div>
        <% } %>
      </div>

      <!-- Back Button -->
      <div class="actions">
        <a href="/" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          V·ªÅ Trang Ch·ªß
        </a>
        <a href="/upload" class="btn btn-primary">
          <i class="fas fa-upload"></i>
          Upload File M·ªõi
        </a>
      </div>
    </div>
  </div>
</main>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .history-item {
    animation: fadeInUp 0.5s ease-out forwards;
  }

  .filter-section {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: var(--shadow);
    margin-bottom: 2rem;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .search-box {
    flex: 1;
    min-width: 250px;
    position: relative;
  }

  .search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-light);
  }

  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.75rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .sort-options {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .sort-options label {
    font-weight: 500;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sort-options select {
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-size: 1rem;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .sort-options select:focus {
    outline: none;
    border-color: var(--primary-color);
  }

  .file-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--primary-color);
    color: white;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: 0.5rem;
  }

  .icon-excel { color: #10b981 !important; }
  .icon-word { color: #3b82f6 !important; }
  .icon-powerpoint { color: #f59e0b !important; }
  .icon-pdf { color: #ef4444 !important; }

  .meta-item {
    background: var(--bg-color);
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
  }
</style>

<script>
  // Filter history by search term
  function filterHistory() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const items = document.querySelectorAll('.history-item');
    
    items.forEach(item => {
      const filename = item.getAttribute('data-filename');
      if (filename.includes(searchTerm)) {
        item.style.display = 'flex';
      } else {
        item.style.display = 'none';
      }
    });

    updateEmptyState();
  }

  // Sort history
  function sortHistory() {
    const sortValue = document.getElementById('sortSelect').value;
    const list = document.getElementById('historyList');
    const items = Array.from(document.querySelectorAll('.history-item'));
    
    items.sort((a, b) => {
      switch(sortValue) {
        case 'date-desc':
          return parseInt(b.getAttribute('data-date')) - parseInt(a.getAttribute('data-date'));
        case 'date-asc':
          return parseInt(a.getAttribute('data-date')) - parseInt(b.getAttribute('data-date'));
        case 'name-asc':
          return a.getAttribute('data-filename').localeCompare(b.getAttribute('data-filename'));
        case 'name-desc':
          return b.getAttribute('data-filename').localeCompare(a.getAttribute('data-filename'));
        case 'size-desc':
          return parseInt(b.getAttribute('data-size')) - parseInt(a.getAttribute('data-size'));
        case 'size-asc':
          return parseInt(a.getAttribute('data-size')) - parseInt(b.getAttribute('data-size'));
        default:
          return 0;
      }
    });

    // Re-append sorted items
    items.forEach(item => list.appendChild(item));
  }

  // Update empty state visibility
  function updateEmptyState() {
    const items = document.querySelectorAll('.history-item');
    const visibleItems = Array.from(items).filter(item => item.style.display !== 'none');
    
    let emptyState = document.querySelector('.empty-state-search');
    if (visibleItems.length === 0 && items.length > 0) {
      if (!emptyState) {
        emptyState = document.createElement('div');
        emptyState.className = 'empty-state empty-state-search';
        emptyState.innerHTML = `
          <i class="fas fa-search"></i>
          <h3>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</h3>
          <p>Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c</p>
        `;
        document.getElementById('historyList').appendChild(emptyState);
      }
    } else if (emptyState) {
      emptyState.remove();
    }
  }

  // Delete analysis with confirmation
  async function deleteAnalysis(id) {
    // Custom confirmation dialog
    const confirmDelete = confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ph√¢n t√≠ch n√†y?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.');
    
    if (!confirmDelete) {
      return;
    }

    // Show loading state
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
      const response = await fetch(`/history/delete/${id}`, {
        method: 'DELETE'
      });

      const result = await response.json();

      if (result.success) {
        // Success animation
        const item = btn.closest('.history-item');
        item.style.transition = 'all 0.3s ease';
        item.style.opacity = '0';
        item.style.transform = 'translateX(-100%)';
        
        setTimeout(() => {
          location.reload();
        }, 300);
      } else {
        alert('‚ùå L·ªói: ' + result.error);
        btn.innerHTML = originalHTML;
        btn.disabled = false;
      }
    } catch (error) {
      alert('‚ùå Kh√¥ng th·ªÉ x√≥a: ' + error.message);
      console.error('Error:', error);
      btn.innerHTML = originalHTML;
      btn.disabled = false;
    }
  }

  // Add smooth scroll to top button
  window.addEventListener('scroll', () => {
    const scrollBtn = document.getElementById('scrollTopBtn');
    if (window.pageYOffset > 300) {
      if (!scrollBtn) {
        const btn = document.createElement('button');
        btn.id = 'scrollTopBtn';
        btn.innerHTML = '<i class="fas fa-arrow-up"></i>';
        btn.style.cssText = `
          position: fixed;
          bottom: 2rem;
          right: 2rem;
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
          color: white;
          border: none;
          box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
          cursor: pointer;
          z-index: 1000;
          transition: all 0.3s ease;
        `;
        btn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
        document.body.appendChild(btn);
      }
    } else if (scrollBtn) {
      scrollBtn.remove();
    }
  });
</script>

<%- include('partials/footer') %>
